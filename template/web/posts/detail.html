<link href="/web/css/monokai-sublime.min.css" rel="stylesheet"/>
<script src="/web/js/editor.min.js"></script>
<script src="/web/js/highlight.min.js"></script>
<style>
    .comment-action {
        font-size: 13px;
        color: #999;
        cursor: pointer;
    }

    .posts-content img {
        max-width: 100%;
        border-radius: 2px;
    }
</style>
<div class="col-sm-9">
    {{AlertComponent .Session.error "danger"}}
    {{AlertComponent .Session.success "success"}}
    <ul class="list-group list-group-flush">
        <li class="list-group-item"><a href="">V2EX</a> › <a href="">游戏</a></li>
        <li class="list-group-item">
            <h5>{{ .posts.title }}</h5>
            <div>
                <a href="" class="badge badge-light" style="color: #acacac;"
                ><i class="fa fa-tag"></i> {{.posts.node_name}}</a
                >
                <a href="" class="badge badge-light" style="color: #acacac;"
                ><i class="fa fa-user"></i> {{.posts.user_name}}</a
                >
                <span class="badge badge-light" style="color: #acacac;"
                ><i class="fa fa-clock"></i> {{StrTime .posts.create_at.String}}</span
                >
                <span class="badge badge-light" style="color: #acacac;"
                ><i class="fa fa-comment"></i> {{.posts.view_num}}</span
                >
            </div>
        </li>
        <li class="list-group-item posts-content">
            {{ .posts.content }}
        </li>
        <li class="list-group-item mt-2" style="color: #999;font-size: 14px;">
            {{ .posts.comment_num }} 条回复
        </li>
        {{range $comment := .comments}}
            <div class="list-group-item">
                <div class="comment-user-info" style="height: 22px;">
                    <a href="/users/{{$comment.uid}}">
                        <img
                                src="{{$comment.avatar}}"
                                style="border-radius:50%;height: 30px;width:30px;"
                        />
                    </a>
                    <a href="" style="font-size: 14px;color:#999;"
                    ><strong>{{$comment.name}}</strong></a
                    >
                    <span style="font-size: 12px;color: #999;"
                    >{{StrTime $comment.create_at.String}}</span
                    >
                </div>
                <br/>
                <div class="comment-content" style="font-size: 14px;">
                    {{if gt $comment.ruid 0}} @
                    <a href="" style="color: #778087;">{{ $comment.r_user_name }}</a>
                    {{end}}
                    <p>{{ $comment.content }}</p>
                    <!-- Whether to log in -->
                    {{if $.Session.user.id}}
                        <p style="width: 100%;text-align: right;">
                            <span class="comment-action comment-reply" data-id="{{ $comment.id }}">回复</span>
                            <span class="comment-action comment-report" data-id="{{ $comment.id }}">举报</span>
                            {{if eq $.Session.user.id $comment.uid}}
                                <span class="comment-action comment-delete">删除</span>
                            {{end}}
                        <form action="/comments/{{ $comment.id }}/delete" class="delete-form" method="POST"
                              style="display: none;"></form>
                        </p>
                    {{end}}
                </div>
            </div>
        {{end}}
        <li class="list-group-item">
            <div class="page">
                {{ .page }}
            </div>
        </li>
        <!-- Comment box -->
        <li class="list-group-item mt-2">
            {{if eq .Session.user.id ""}}
                需要<a href="/user/login" class="btn btn-link">登录</a>
                后方可回复, 如果你还没有账号请点击这里<a href="/user/register" class="btn btn btn-link">注册</a>。
            {{else}}
                <form action="/comments" method="POST" class="mt-2" id="comment-form">
                    <div class="form-group">
                        <div id="wang-editor"></div>
                        <input type="hidden" name="content" id="html-content">
                    </div>
                    <input type="hidden" name="pid" value="{{ .posts.id }}">
                    <input type="hidden" name="ruid" value="0">
                    <input type="hidden" name="uid" value="{{ .Session.user.id }}">
                    <div class="form-group">
                        <button class="btn btn-primary submit-btn" type="button">
                            回复
                        </button>
                    </div>
                </form>
            {{end}}
        </li>
    </ul>
</div>
<script>
    $(function () {
        hljs.initHighlightingOnLoad();

        $(".submit-btn").on("click", function () {
            // Determine whether to log in
            if ("{{ .Session.user.id }}" !== "") {
                $("#comment-form").submit();
            } else {
                alert("请先登录");
            }
        });

        $('.comment-action').on('click', function () {
            // 删除评论
            if ($(this).hasClass('comment-delete')) {
                $('.delete-form').submit();
            }
        })

        // Initialize rich text
        const E = window.wangEditor;
        const editor = new E("#wang-editor");
        editor.highlight = hljs;
        editor.config.onchange = function (html) {
            $("#html-content").val(html);
        };
        // Editor menu items
        editor.config.menus = [
            "head",
            "bold",
            "fontSize",
            "fontName",
            "italic",
            "underline",
            "strikeThrough",
            "indent",
            "lineHeight",
            "foreColor",
            "backColor",
            "link",
            "list",
            "justify",
            "quote",
            // "image",
            // "table",
            // "code",
            "splitLine",
            "undo",
            "redo"
        ];
        editor.config.hashjs = true;
        // Ignore pictures in pasted content
        editor.config.pasteIgnoreImg = true;
        // Upload file name
        editor.config.uploadFileName = "file";
        // Upload request URL
        editor.config.uploadImgServer = "/editor/file";
        // Upload parameter settings
        editor.config.uploadImgParams = {};
        // Create editor
        editor.create();
    });
</script>
